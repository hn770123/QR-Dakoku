# 実装メモ

## 実装内容のサマリー

このドキュメントは、QRコード出退勤記録システムの実装に関する技術的な詳細をまとめたものです。

## 実装された機能

### フロントエンド（GitHub Pages）

#### QRコード表示ページ (`docs/index.html`)
- 出勤・退勤ボタン
- トークン生成（SHA-256ハッシュ、端末ID、アクション種別を含む）
- QRコード表示（qrcode.js使用）
- 5分間のカウントダウンタイマー
- 自動期限切れ処理
- 色分け表示（出勤：緑、退勤：ピンク）

#### 設定ページ (`docs/settings.html`)
- 端末ID入力（英数字、ハイフン、アンダースコアのみ）
- パスキー入力（8文字以上、マスキング機能付き）
- リンク先URL入力（URL形式検証）
- ローカルストレージへの保存
- バリデーション機能

#### PWA機能
- Service Worker (`sw.js`)によるオフラインキャッシング
- マニフェストファイル (`manifest.json`)
- ホーム画面へのインストール対応

### バックエンド（Node.js/Express）

#### 受付ページ (`server/server.js`)
- `/receive`エンドポイント：QRコード読み取り後のアクセス処理
- `/register`エンドポイント：初回ユーザー登録
- トークン検証（SHA-256ハッシュの再計算と比較）
- 有効期限チェック（5分）
- クッキーによるユーザー識別
- ログ記録（JSON形式、1行1エントリ）

#### ユーティリティ (`server/utils.js`)
- トークン検証関数
- 有効期限チェック関数
- ログファイル管理（年月ごとに自動分割）
- 設定ファイル読み込み

## 技術的な選択

### トークン生成方式

```javascript
// データ結合
const data = `${deviceId}|${actionType}|${timestamp}|${passkey}`;
// SHA-256ハッシュ生成
const hash = sha256(data);
// 先頭32文字をトークンとして使用
const token = hash.substring(0, 32);
```

**選択理由**:
- SHA-256は広く使われている暗号学的ハッシュ関数
- パスキーを含めることでセキュリティを確保
- タイムスタンプを含めることでリプレイ攻撃を防止

### ローカルストレージの使用

フロントエンドの設定保存にローカルストレージを使用。

**選択理由**:
- サーバー不要でオフライン動作可能
- 端末ごとの設定を保持
- シンプルな実装

### ログファイル形式

JSON形式で1行1エントリ。

**選択理由**:
- パースが容易
- 追記が簡単
- 各種ツールで処理しやすい

### PWA対応

Service Workerとマニフェストファイルを使用。

**選択理由**:
- オフライン動作が要件
- ホーム画面へのインストールで使いやすさ向上
- 標準的な技術

## ファイル構成

```
QR-Dakoku/
├── docs/                           # GitHub Pagesで公開
│   ├── index.html                 # メインページ
│   ├── settings.html              # 設定ページ
│   ├── manifest.json              # PWAマニフェスト
│   ├── sw.js                      # Service Worker
│   ├── SETUP.md                   # セットアップガイド
│   ├── css/style.css              # スタイルシート
│   ├── js/
│   │   ├── app.js                # メインロジック
│   │   ├── config.js             # 設定管理
│   │   ├── token.js              # トークン生成
│   │   ├── settings.js           # 設定ページロジック
│   │   └── sw-register.js        # SW登録
│   └── images/                    # PWAアイコン
│
├── server/                        # バックエンド
│   ├── server.js                 # メインサーバー
│   ├── utils.js                  # ユーティリティ
│   ├── package.json              # npm設定
│   ├── PRODUCTION.md             # 本番環境ガイド
│   ├── config/
│   │   └── devices.json.example  # 設定例
│   └── logs/                     # ログディレクトリ（自動生成）
│
├── .github/
│   └── workflows/
│       └── pages.yml             # GitHub Actionsワークフロー
│
├── README.md                      # プロジェクト説明
├── .gitignore                     # Git除外設定
└── IMPLEMENTATION_NOTES.md        # このファイル
```

## セキュリティ考慮事項

### 実装済み
1. トークンのハッシュ化（SHA-256）
2. 有効期限の設定（5分）
3. サーバー側でのトークン検証
4. httpOnly cookieの使用
5. Cookie属性の適切な設定（secure, sameSite）

### 本番環境での推奨事項
1. レート制限の実装（`PRODUCTION.md`参照）
2. HTTPS通信の使用
3. リバースプロキシの使用
4. ファイアウォール設定
5. ログファイルのアクセス制限

### 既知の制限事項
1. **レート制限**: 現在未実装。本番環境では`express-rate-limit`の使用を推奨
2. **認証機能**: ユーザー名のみでパスワード認証なし（要件による）
3. **ログの永続化**: ファイルシステムのみ（データベース未使用）

## テスト

### 実施したテスト
- フロントエンドの動作確認（ブラウザテスト）
- 設定保存・読み込みの確認
- バックエンドのシンタックスチェック
- CodeQLセキュリティスキャン

### 手動テスト手順

1. **設定の保存**
   ```
   1. 設定ページにアクセス
   2. 端末ID、パスキー、URLを入力
   3. 保存ボタンをクリック
   4. メインページに自動遷移することを確認
   ```

2. **QRコード生成**
   ```
   1. メインページで出勤または退勤をクリック
   2. QRコードが表示されることを確認
   3. タイマーが動作することを確認
   4. 5分後に自動的に閉じることを確認
   ```

3. **受付ページ**
   ```
   1. サーバーを起動
   2. QRコードを読み取り
   3. 初回：ユーザー名登録画面が表示されることを確認
   4. 2回目以降：自動的に記録されることを確認
   5. ログファイルが生成されることを確認
   ```

## 依存ライブラリ

### フロントエンド（CDN）
- qrcode.js v1.5.3 - QRコード生成
- js-sha256 v0.9.0 - SHA-256ハッシュ生成

### バックエンド（npm）
- express ^4.18.2 - Webフレームワーク
- cookie-parser ^1.4.6 - クッキー処理

## 今後の拡張案

1. **管理画面**: ログの閲覧・検索機能
2. **統計機能**: 出退勤の統計情報表示
3. **通知機能**: 出退勤時のメール通知
4. **データベース**: ログのDB保存
5. **ユーザー管理**: 管理者向けユーザー管理機能
6. **API**: ログデータへのAPI経由アクセス

## トラブルシューティング

### よくある問題

1. **QRコードが生成されない**
   - 設定が完了していない
   - ブラウザのコンソールでエラーを確認
   - CDNライブラリが読み込めているか確認

2. **トークンが無効**
   - サーバーの設定ファイル（devices.json）を確認
   - パスキーがフロントエンドと一致しているか確認
   - 有効期限（5分）が切れていないか確認

3. **ログが記録されない**
   - サーバーの権限を確認
   - logs/ディレクトリが作成されているか確認
   - サーバーログでエラーを確認

## 開発環境

- Node.js v20.19.5
- npm v10.8.2
- ブラウザ: Chrome, Safari, Firefox（最新版）

## ライセンス

MIT License
